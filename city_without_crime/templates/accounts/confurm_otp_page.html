{% extends 'base.html' %}

{% block title %}Verify OTP - College Grievance System{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-info text-white text-center py-4">
                    <h3><i class="fas fa-shield-alt me-2"></i>Verify Email</h3>
                    <p class="mb-0">Enter the OTP sent to your email</p>
                </div>
                <div class="card-body p-5 text-center">
                    <div class="mb-4">
                        
                        <p>We've sent a 6-digit verification code to:<br>
                        <strong>{{ user_email }}</strong></p>
                    </div>
                    
                    <!-- Error Message Display -->
                    {% if messages %}
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        {% for message in messages %}
                            {{ message }}
                        {% endfor %}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endif %}
                    
                    <form   action="{% url 'update_password' %}" id="otpForm">
                        {% csrf_token %}
                        <input type="hidden" name="user_email" value="{{ user_email }}">
                        
                        <div class="mb-4">
                            <label for="otp" class="form-label">Enter OTP</label>
                            <input type="text" class="form-control text-center fs-3" id="otp" name="otp" 
                                   maxlength="6" pattern="[0-9]{6}" required 
                                   style="letter-spacing: 10px; font-weight: bold;">
                            <div class="form-text">Enter the 6-digit code from your email</div>
                            <div id="otpError" class="text-danger mt-2" style="display: none;">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                <span id="errorText">Invalid OTP. Please try again.</span>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-info btn-lg" id="submitBtn">
                                <i class="fas fa-check me-2"></i>Verify & Complete Registration
                            </button>
                        </div>
                    </form>
                    
                     
                    
                    <!-- Hidden OTP for demo -->
                    
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const otpInput = document.getElementById('otp');
    const otpForm = document.getElementById('otpForm');
    const submitBtn = document.getElementById('submitBtn');
    const otpError = document.getElementById('otpError');
    const resendOtp = document.getElementById('resendOtp');
    const correctOtp = "{{ otp }}";  // Views se passed OTP

    // OTP input validation
    otpInput.addEventListener('input', function(e) {
        // Allow only numbers
        this.value = this.value.replace(/[^0-9]/g, '');
        
        // Hide error when user types
        otpError.style.display = 'none';
        
        // Enable/disable submit based on length
        submitBtn.disabled = this.value.length !== 6;
    });

    // Form submission handling
    otpForm.addEventListener('submit', function(e) {
        const enteredOtp = parseInt(otpInput.value.trim());
        const correctOtp={{otp}}
         
        
        // Client-side OTP validation
        if (enteredOtp != correctOtp) {
            e.preventDefault(); // Prevent form submission
            
            // Show error message
            otpError.style.display = 'block';
            otpInput.focus();
            otpInput.auto()
            
            
            // Shake animation for error
            otpInput.classList.add('is-invalid');
            setTimeout(() => {
                otpInput.classList.remove('is-invalid');
            }, 500);
            
            return false;
        }
        
        // If OTP is correct, show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Verifying...';
    });

    // Resend OTP handling
    resendOtp.addEventListener('click', function(e) {
        e.preventDefault();
        
        const originalText = this.innerHTML;
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';
        
        // Submit the resend form
        document.getElementById('resendForm').submit();
        
        // Re-enable after 5 seconds if still on page
        setTimeout(() => {
            this.disabled = false;
            this.innerHTML = originalText;
        }, 5000);
    });

    // Auto-focus on OTP input
    otpInput.focus();
});
</script>

<style>
.is-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    animation: shake 0.5s;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}
</style>
{% endblock %}