<!-- templates/accounts/register.html -->
{% extends 'base.html' %}

{% block title %}change password{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0"><i class="fas fa-user-plus me-2"></i>Change Password</h3>
            </div>
            <div class="card-body">
                <form method="post" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <!-- Display form-wide errors -->
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <div class="row">
                        <!-- Password Field -->
                        <div class="col-md-6 mb-3">
                            <label for="id_password1" class="form-label">
                                <i class="bi bi-lock-fill me-2"></i>Password
                            </label>
                            <div class="input-group">
                                <input type="password" 
                                       class="form-control {% if form.password1.errors %}is-invalid{% endif %}" 
                                       id="id_password1" 
                                       name="password1" 
                                       required
                                       minlength="8"
                                       data-password-validate
                                       placeholder="Enter password">
                                <button type="button" 
                                        class="btn btn-outline-secondary toggle-password" 
                                        data-target="id_password1">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if form.password1.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.password1.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="password-requirements mt-2">
                                <small class="form-text text-muted">Password must contain:</small>
                                <ul class="list-unstyled">
                                    <li class="text-muted" data-requirement="length"><i class="fas fa-circle-notch fa-xs"></i> At least 8 characters</li>
                                    <li class="text-muted" data-requirement="uppercase"><i class="fas fa-circle-notch fa-xs"></i> At least 1 uppercase letter</li>
                                    <li class="text-muted" data-requirement="lowercase"><i class="fas fa-circle-notch fa-xs"></i> At least 1 lowercase letter</li>
                                    <li class="text-muted" data-requirement="number"><i class="fas fa-circle-notch fa-xs"></i> At least 1 number</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Password Confirmation Field -->
                        <div class="col-md-6 mb-3">
                            <label for="id_password2" class="form-label">
                                <i class="bi bi-lock-fill me-2"></i>Confirm Password
                            </label>
                            <div class="input-group">
                                <input type="password" 
                                       class="form-control {% if form.password2.errors %}is-invalid{% endif %}" 
                                       id="id_password2" 
                                       name="password2" 
                                       required
                                       data-password-confirm
                                       placeholder="Confirm password">
                                <button type="button" 
                                        class="btn btn-outline-secondary toggle-password" 
                                        data-target="id_password2">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if form.password2.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.password2.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="form-text text-muted" id="password-match-feedback">
                                <!-- Password match feedback will appear here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Update Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Password strength validation
    const password1 = document.getElementById('id_password1');
    const password2 = document.getElementById('id_password2');
    const requirements = {
        length: document.querySelector('[data-requirement="length"]'),
        uppercase: document.querySelector('[data-requirement="uppercase"]'),
        lowercase: document.querySelector('[data-requirement="lowercase"]'),
        number: document.querySelector('[data-requirement="number"]')
    };
    
    // Hide/Show Password Functionality
    const toggleButtons = document.querySelectorAll('.toggle-password');
    
    toggleButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const passwordInput = document.getElementById(targetId);
            const icon = this.querySelector('i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
                this.setAttribute('title', 'Hide password');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
                this.setAttribute('title', 'Show password');
            }
        });
    });
    
    function validatePassword() {
        const value = password1.value;
        
        // Check requirements
        const hasLength = value.length >= 8;
        const hasUppercase = /[A-Z]/.test(value);
        const hasLowercase = /[a-z]/.test(value);
        const hasNumber = /\d/.test(value);
        
        // Update requirement indicators
        updateRequirement(requirements.length, hasLength);
        updateRequirement(requirements.uppercase, hasUppercase);
        updateRequirement(requirements.lowercase, hasLowercase);
        updateRequirement(requirements.number, hasNumber);
        
        return hasLength && hasUppercase && hasLowercase && hasNumber;
    }
    
    function updateRequirement(element, isValid) {
        const text = element.textContent.replace(/^.*?<\/i>\s*/, '').trim();
        if (isValid) {
            element.classList.remove('text-muted');
            element.classList.add('text-success');
            element.innerHTML = '<i class="fas fa-check-circle text-success"></i> ' + text;
        } else {
            element.classList.remove('text-success');
            element.classList.add('text-muted');
            element.innerHTML = '<i class="fas fa-circle-notch text-muted"></i> ' + text;
        }
    }
    
    function validatePasswordMatch() {
        const feedback = document.getElementById('password-match-feedback');
        
        if (password2.value.length === 0) {
            feedback.textContent = '';
            feedback.className = 'form-text text-muted';
            return true;
        }
        
        if (password1.value === password2.value) {
            feedback.textContent = '✓ Passwords match';
            feedback.className = 'form-text text-success';
            password2.setCustomValidity('');
            return true;
        } else {
            feedback.textContent = '✗ Passwords do not match';
            feedback.className = 'form-text text-danger';
            password2.setCustomValidity("Passwords don't match");
            return false;
        }
    }
    
    // Real-time validation
    password1.addEventListener('input', function() {
        validatePassword();
        validatePasswordMatch();
    });
    
    password2.addEventListener('input', validatePasswordMatch);
    
    // Form validation
    const form = document.querySelector('.needs-validation');
    form.addEventListener('submit', function(event) {
        const isPasswordValid = validatePassword();
        const isPasswordMatch = validatePasswordMatch();
        
        if (!form.checkValidity() || !isPasswordValid || !isPasswordMatch) {
            event.preventDefault();
            event.stopPropagation();
            
            // Show specific error messages
            if (!isPasswordValid) {
                password1.setCustomValidity('Please meet all password requirements');
            }
        }
        
        form.classList.add('was-validated');
    }, false);
    
    // Initialize validation on page load
    validatePassword();
});
</script>

<style>
.input-group .toggle-password {
    border-left: 0;
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
}

.input-group .form-control:focus {
    z-index: 3; /* Ensure focus border appears above button */
}

.password-requirements ul {
    margin-bottom: 0;
}

.password-requirements li {
    font-size: 0.875rem;
    margin-bottom: 2px;
}

/* Optional: Add some animation to the icons */
.toggle-password i {
    transition: transform 0.2s ease;
}

.toggle-password:hover i {
    transform: scale(1.1);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .col-md-6 {
        margin-bottom: 1rem;
    }
}
</style>
{% endblock %}